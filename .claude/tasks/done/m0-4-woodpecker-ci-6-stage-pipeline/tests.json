{
  "schema_version": "2026.02",
  "task_slug": "m0-4-woodpecker-ci-6-stage-pipeline",
  "test_strategy": "infrastructure_validation",
  "tests": [
    {
      "id": "T1",
      "wave": 1,
      "feature": "F1",
      "name": "vitest_in_catalog",
      "description": "Verify vitest is listed in pnpm-workspace.yaml catalog section",
      "type": "validation",
      "command": "grep -q 'vitest' pnpm-workspace.yaml",
      "expected": "vitest entry exists in catalog"
    },
    {
      "id": "T2",
      "wave": 1,
      "feature": "F2",
      "name": "turbo_test_task_exists",
      "description": "Verify turbo.json contains a test task definition",
      "type": "validation",
      "command": "cat turbo.json | python3 -c \"import sys,json; d=json.load(sys.stdin); assert 'test' in d['tasks'], 'No test task'\"",
      "expected": "test task exists in turbo.json tasks"
    },
    {
      "id": "T3",
      "wave": 1,
      "feature": "F3",
      "name": "root_test_script_exists",
      "description": "Verify root package.json has a test script",
      "type": "validation",
      "command": "cat package.json | python3 -c \"import sys,json; d=json.load(sys.stdin); assert 'test' in d['scripts'], 'No test script'\"",
      "expected": "test script exists in root package.json"
    },
    {
      "id": "T4",
      "wave": 1,
      "feature": "F4",
      "name": "vitest_workspace_config_exists",
      "description": "Verify vitest.workspace.ts file exists at repo root",
      "type": "validation",
      "command": "test -f vitest.workspace.ts",
      "expected": "vitest.workspace.ts exists"
    },
    {
      "id": "T5",
      "wave": 1,
      "feature": "F5",
      "name": "validators_tests_pass_with_vitest",
      "description": "Run pnpm test and verify validators package tests pass via Vitest",
      "type": "unit",
      "command": "pnpm test",
      "expected": "All validator tests pass with vitest runner"
    },
    {
      "id": "T6",
      "wave": 2,
      "feature": "F6",
      "name": "health_endpoint_file_exists",
      "description": "Verify health check route file exists at expected path",
      "type": "validation",
      "command": "test -f apps/web/src/app/api/health/route.ts",
      "expected": "health route.ts exists"
    },
    {
      "id": "T7",
      "wave": 2,
      "feature": "F6",
      "name": "health_endpoint_exports_get",
      "description": "Verify health route exports a GET handler",
      "type": "validation",
      "command": "grep -q 'export.*GET' apps/web/src/app/api/health/route.ts",
      "expected": "GET handler exported"
    },
    {
      "id": "T8",
      "wave": 2,
      "feature": "F7",
      "name": "env_ci_exists",
      "description": "Verify .env.ci file exists with required CI variables",
      "type": "validation",
      "command": "test -f .env.ci && grep -q 'AUTH_SECRET' .env.ci && grep -q 'CONVEX_DEPLOYMENT' .env.ci",
      "expected": ".env.ci exists with AUTH_SECRET and CONVEX_DEPLOYMENT"
    },
    {
      "id": "T9",
      "wave": 3,
      "feature": "F8",
      "name": "woodpecker_yml_exists",
      "description": "Verify .woodpecker.yml file exists at repo root",
      "type": "validation",
      "command": "test -f .woodpecker.yml",
      "expected": ".woodpecker.yml exists"
    },
    {
      "id": "T10",
      "wave": 3,
      "feature": "F8",
      "name": "woodpecker_has_6_stages",
      "description": "Verify .woodpecker.yml contains all 6 named stages",
      "type": "validation",
      "command": "grep -c 'name:' .woodpecker.yml",
      "expected": "At least 7 named steps (setup + 6 stages)"
    },
    {
      "id": "T11",
      "wave": 3,
      "feature": "F8",
      "name": "woodpecker_triggers_on_push_and_pr",
      "description": "Verify pipeline triggers on both push and pull_request events",
      "type": "validation",
      "command": "grep -q 'push' .woodpecker.yml && grep -q 'pull_request' .woodpecker.yml",
      "expected": "Both push and pull_request triggers present"
    },
    {
      "id": "T12",
      "wave": 0,
      "feature": null,
      "name": "typecheck_passes",
      "description": "Verify pnpm typecheck still passes after all changes (regression check)",
      "type": "regression",
      "command": "pnpm typecheck",
      "expected": "Zero TypeScript errors"
    }
  ]
}
