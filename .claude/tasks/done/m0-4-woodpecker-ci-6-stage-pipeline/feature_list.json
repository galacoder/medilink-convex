{
  "schema_version": "2026.02",
  "exp_version": "1.0",
  "task_description": "M0-4: Woodpecker CI -- 6-Stage Pipeline. Configure Woodpecker CI with standard 6-stage pipeline: lint+typecheck+build, unit tests, smoke tests, E2E tests, VRT, and summary. This pipeline serves as automated code reviewer -- no human code review, CI IS the quality gate.",
  "task_slug": "m0-4-woodpecker-ci-6-stage-pipeline",
  "summary": "Configure Woodpecker CI with a 6-stage pipeline (lint+typecheck+build, unit tests, smoke tests, E2E placeholder, VRT placeholder, summary) that replaces human code review as the quality gate. Requires setting up Vitest test infrastructure, a health check endpoint for smoke testing, and the complete .woodpecker.yml pipeline definition with proper stage dependencies and caching.",
  "execution_mode": {
    "type": "auto",
    "auto_complete": true,
    "auto_verify": true
  },
  "meta": {
    "exp_version": "v1.0.0",
    "git_integration": {
      "worktree_enabled": true,
      "worktree_path": "/home/sangle/dev/medilink-convex/../worktrees/m0-4-woodpecker-ci-6-stage-pipeline",
      "branch_name": "feat/infra/m0-4-woodpecker-ci-6-stage-pipeline",
      "base_branch": "main"
    },
    "github_integration": {
      "issue_number": 49,
      "issue_url": "https://github.com/galacoder/medilink-convex/issues/49",
      "issue_title": "M0-4: Woodpecker CI -- 6-Stage Pipeline",
      "task_type": "scaffold",
      "issue_source": "user_provided",
      "has_structured_requirements": true,
      "issue_requirements": {
        "user_stories": [
          {
            "id": "US-001",
            "description": "As platform_admin, I want automated 6-stage CI pipeline so every code change is validated before merging",
            "status": "pending"
          }
        ],
        "acceptance_criteria": [
          {
            "item": ".woodpecker.yml with 6 stages: lint+typecheck+build -> tests -> smoke -> E2E -> VRT -> summary",
            "status": "pending"
          },
          {
            "item": "Stage 1: pnpm lint && pnpm typecheck && pnpm build pass",
            "status": "pending"
          },
          {
            "item": "Stage 2: pnpm test (Vitest unit tests)",
            "status": "pending"
          },
          {
            "item": "Stage 3: Smoke test (app starts, health endpoint responds)",
            "status": "pending"
          },
          {
            "item": "Stage 4: Playwright E2E tests (placeholder)",
            "status": "pending"
          },
          {
            "item": "Stage 5: VRT screenshot comparison (placeholder)",
            "status": "pending"
          },
          {
            "item": "Stage 6: Summary report (pass/fail counts, badge)",
            "status": "pending"
          },
          {
            "item": "Pipeline triggers on push to main and PRs",
            "status": "pending"
          },
          {
            "item": "Pipeline completes under 5 minutes for stages 1-3",
            "status": "pending"
          },
          {
            "item": "TypeScript types pass pnpm typecheck with zero errors in CI",
            "status": "pending"
          }
        ],
        "files_to_create": [
          ".woodpecker.yml",
          "apps/web/src/app/api/health/route.ts"
        ],
        "files_to_modify": [
          "turbo.json"
        ]
      }
    },
    "standards_context": {
      "has_standards": false,
      "source": "not_found",
      "standards_path": "",
      "applicable_standards": [],
      "domains": []
    },
    "memory_context": {
      "has_memories": false,
      "query_executed_at": "planning",
      "memories": []
    },
    "key_findings": [
      "No Woodpecker CI config exists -- must create .woodpecker.yml from scratch",
      "Existing GitHub Actions CI (.github/workflows/ci.yml) has 3 parallel jobs: lint, format, typecheck -- will coexist with Woodpecker",
      "No Vitest configured anywhere -- no vitest.config, no vitest in catalog, no test runner dependencies",
      "2 test files in packages/validators use custom tsx runner with hand-rolled test/expect -- must migrate to Vitest",
      "No root pnpm test script and no turbo test task -- both must be created",
      "No health endpoint exists at /api/health -- must create for smoke test stage",
      "Vite 7.1.12 already in pnpm catalog -- Vitest 3.x compatible",
      "Node 22.21.0 + pnpm 10.19.0 specified in engines -- Docker image must match",
      "Turbo remote caching available via TURBO_TEAM + TURBO_TOKEN env vars",
      "Workspace shares volume between Woodpecker steps -- node_modules persists across stages"
    ],
    "key_sources": [
      {
        "index": 1,
        "path": ".github/workflows/ci.yml",
        "description": "Existing GitHub Actions CI (3-stage: lint, format, typecheck)"
      },
      {
        "index": 2,
        "path": "turbo.json",
        "description": "Turbo task definitions -- needs test task added"
      },
      {
        "index": 3,
        "path": "package.json",
        "description": "Root scripts -- needs test script added"
      },
      {
        "index": 4,
        "path": "pnpm-workspace.yaml",
        "description": "Workspace catalog -- needs vitest added"
      },
      {
        "index": 5,
        "path": "packages/validators/package.json",
        "description": "Only package with tests -- uses tsx runner"
      },
      {
        "index": 6,
        "path": "packages/validators/src/organizations.test.ts",
        "description": "Existing tests with hand-rolled test runner -- 20+ assertions"
      },
      {
        "index": 7,
        "path": "tooling/github/setup/action.yml",
        "description": "GitHub Actions setup composite action (pnpm + node setup)"
      },
      {
        "index": 8,
        "path": ".env.example",
        "description": "Environment template -- basis for .env.ci"
      },
      {
        "index": 9,
        "path": "apps/web/package.json",
        "description": "Next.js app config -- has start script for smoke testing"
      },
      {
        "index": 10,
        "path": ".nvmrc",
        "description": "Node version pinned to 22.21.0"
      }
    ],
    "explore_agents": 3,
    "async_strategy": "sequential_waves"
  },
  "features": [
    {
      "id": "F1",
      "wave": 1,
      "name": "Add vitest to pnpm workspace catalog",
      "description": "Add vitest and @vitest/coverage-v8 to pnpm-workspace.yaml catalog so all packages can use a consistent vitest version via catalog: protocol",
      "status": "pending",
      "priority": "high",
      "tests_required": false
    },
    {
      "id": "F2",
      "wave": 1,
      "name": "Add turbo test task and update build outputs",
      "description": "Add a test task to turbo.json that depends on ^build, and update the build task outputs to include .next/** for Next.js build caching in CI",
      "status": "pending",
      "priority": "high",
      "tests_required": false
    },
    {
      "id": "F3",
      "wave": 1,
      "name": "Add root pnpm test script",
      "description": "Add test script to root package.json that runs turbo run test, enabling pnpm test from repo root for CI stage 2",
      "status": "pending",
      "priority": "high",
      "tests_required": false
    },
    {
      "id": "F4",
      "wave": 1,
      "name": "Create vitest workspace configuration",
      "description": "Create vitest.workspace.ts at repo root that discovers all packages with vitest configs, starting with packages/validators",
      "status": "pending",
      "priority": "medium",
      "tests_required": false
    },
    {
      "id": "F5",
      "wave": 1,
      "name": "Migrate packages/validators tests to vitest",
      "description": "Replace hand-rolled test/expect runner in organizations.test.ts and auth.test.ts with vitest describe/it/expect. Add vitest as devDependency via catalog. Update test script from tsx to vitest.",
      "status": "pending",
      "priority": "high",
      "tests_required": true
    },
    {
      "id": "F6",
      "wave": 2,
      "name": "Create health check API route",
      "description": "Create GET /api/health endpoint at apps/web/src/app/api/health/route.ts that returns JSON {status: 'ok', timestamp} for CI smoke test verification",
      "status": "pending",
      "priority": "high",
      "tests_required": false
    },
    {
      "id": "F7",
      "wave": 2,
      "name": "Create .env.ci template",
      "description": "Create .env.ci with CI-safe placeholder values for CONVEX_DEPLOYMENT, NEXT_PUBLIC_CONVEX_URL, AUTH_SECRET, and other required env vars so CI can run without real secrets",
      "status": "pending",
      "priority": "medium",
      "tests_required": false
    },
    {
      "id": "F8",
      "wave": 3,
      "name": "Create .woodpecker.yml with 6-stage pipeline",
      "description": "Create complete Woodpecker CI pipeline with 6 stages using depends_on for DAG ordering: (1) lint+typecheck+build, (2) unit-tests running parallel with stage 1, (3) smoke-test after build, (4) E2E placeholder, (5) VRT placeholder, (6) summary. Uses node:22-alpine image, pnpm caching, and triggers on push to main + PRs.",
      "status": "pending",
      "priority": "critical",
      "tests_required": false
    }
  ],
  "waves": [
    {
      "id": 1,
      "name": "Test Infrastructure Foundation",
      "objective": "Set up Vitest as the project test runner, add turbo test task, create root test script, and migrate existing hand-rolled tests in packages/validators to Vitest. This establishes the foundation that CI Stage 2 (unit tests) depends on.",
      "purpose_narrative": "WHY: Without a proper test runner and turbo test task, the CI pipeline cannot execute Stage 2 (unit tests). The existing packages/validators tests use a hand-rolled runner that is incompatible with CI reporting and coverage. This wave must come first because every subsequent CI stage depends on a working test infrastructure.",
      "complexity": "medium",
      "complexity_reason": "Involves coordinating changes across 5 files (catalog, turbo.json, root package.json, vitest config, validator tests) with cross-dependency on Vite version already in catalog. Test migration requires careful translation of 20+ assertions from custom runner to Vitest API.",
      "model": "sonnet",
      "model_escalation": [
        "opus",
        "opus",
        "opus"
      ],
      "estimate_minutes": 25,
      "tools_to_use": [
        {
          "name": "test-driven-development",
          "type": "skill",
          "relevance_percent": 85,
          "purpose": "TDD methodology for test migration"
        },
        {
          "name": "building-with-turborepo",
          "type": "skill",
          "relevance_percent": 72,
          "purpose": "Turbo task configuration"
        },
        {
          "name": "mcp__sequential-thinking__sequentialthinking",
          "type": "mcp",
          "relevance_percent": null,
          "purpose": "Multi-file coordination planning"
        }
      ],
      "core_tools": [
        "Read",
        "Edit",
        "Bash"
      ],
      "features": [
        "F1",
        "F2",
        "F3",
        "F4",
        "F5"
      ],
      "tests": [
        "vitest_runs_from_root()",
        "validators_tests_pass_with_vitest()",
        "turbo_test_task_resolves()"
      ],
      "files": [
        "pnpm-workspace.yaml",
        "turbo.json",
        "package.json",
        "vitest.workspace.ts",
        "packages/validators/package.json",
        "packages/validators/src/organizations.test.ts",
        "packages/validators/src/auth.test.ts",
        "packages/validators/vitest.config.ts"
      ],
      "status": "complete"
    },
    {
      "id": 2,
      "name": "Smoke Test Prerequisites",
      "objective": "Create the health check API endpoint and CI environment template that the Woodpecker pipeline smoke test stage requires to verify the application starts correctly.",
      "purpose_narrative": "WHY: Stage 3 (smoke test) needs a deterministic endpoint to verify the app is running. The health check at /api/health provides this. The .env.ci template provides CI-safe environment values so the build does not fail on missing secrets. Both must exist before the pipeline YAML references them.",
      "complexity": "low",
      "complexity_reason": "Two small file creations with no external dependencies. Health endpoint is a pure Next.js API route with no database or auth dependencies. .env.ci is a copy of .env.example with CI-safe placeholder values.",
      "model": "sonnet",
      "model_escalation": [
        "opus",
        "opus",
        "opus"
      ],
      "estimate_minutes": 10,
      "tools_to_use": [
        {
          "name": "developing-with-nextjs",
          "type": "skill",
          "relevance_percent": 65,
          "purpose": "Next.js API route patterns"
        }
      ],
      "core_tools": [
        "Read",
        "Write"
      ],
      "features": [
        "F6",
        "F7"
      ],
      "tests": [
        "health_endpoint_returns_200()",
        "env_ci_has_required_vars()"
      ],
      "files": [
        "apps/web/src/app/api/health/route.ts",
        ".env.ci"
      ],
      "status": "complete"
    },
    {
      "id": 3,
      "name": "Woodpecker CI 6-Stage Pipeline",
      "objective": "Create the complete .woodpecker.yml configuration with all 6 stages (lint+typecheck+build, unit-tests, smoke-test, E2E placeholder, VRT placeholder, summary) using DAG-based step ordering, Node 22 Alpine image, pnpm workspace caching, and proper trigger conditions for push-to-main and pull requests.",
      "purpose_narrative": "WHY: This is the core deliverable -- the CI pipeline that replaces human code review as the quality gate. It must come last because it references everything created in Waves 1 and 2: the test task (pnpm test), the health endpoint (/api/health), and the CI environment (.env.ci). The pipeline structure uses Woodpecker's depends_on DAG to maximize parallelism while respecting stage dependencies.",
      "complexity": "high",
      "complexity_reason": "Complex YAML configuration with 8 steps (including setup), DAG dependencies between stages, volume caching for pnpm store, smoke test requiring background process management (start server, wait, curl, kill), placeholder stages with clear documentation for future milestones, and proper Woodpecker when-clause syntax for trigger conditions.",
      "model": "sonnet",
      "model_escalation": [
        "opus",
        "opus",
        "opus"
      ],
      "estimate_minutes": 30,
      "tools_to_use": [
        {
          "name": "mcp__context7__query-docs",
          "type": "mcp",
          "relevance_percent": null,
          "purpose": "Woodpecker CI syntax reference"
        },
        {
          "name": "mcp__sequential-thinking__sequentialthinking",
          "type": "mcp",
          "relevance_percent": null,
          "purpose": "Pipeline stage dependency planning"
        }
      ],
      "core_tools": [
        "Read",
        "Write",
        "Bash"
      ],
      "features": [
        "F8"
      ],
      "tests": [
        "woodpecker_yaml_valid_syntax()",
        "pipeline_has_6_stages()",
        "stages_have_correct_depends_on()"
      ],
      "files": [
        ".woodpecker.yml"
      ],
      "status": "complete"
    }
  ],
  "verification_metadata": {
    "invoked_by": "execute-coding-exp",
    "timestamp": "2026-02-18T02:01:54Z"
  },
  "wave_verifications": [
    {
      "timestamp": "2026-02-18T02:10:53Z",
      "decision": "FIX",
      "invoked_by": "subagent",
      "failure_count": 3,
      "issues": {
        "critical": 1,
        "high": 2,
        "medium": 2,
        "critical_detail": ".woodpecker.yml uses Woodpecker v1 flat-step format; v3.13.0 requires steps: array"
      }
    },
    {
      "timestamp": "2026-02-18T02:14:35Z",
      "decision": "PROCEED",
      "invoked_by": "direct",
      "failure_count": 0,
      "issues": {
        "critical": 0,
        "high": 0
      }
    }
  ],
  "retry_history": [
    {
      "attempt": 1,
      "timestamp": "2026-02-18T02:11:12Z",
      "phase": "fix",
      "decision": "FIX",
      "failure_count": 3,
      "issue": ".woodpecker.yml uses v1 flat-step format, needs v3 steps: array"
    }
  ],
  "verification_status": "passed",
  "verification_experimental": true,
  "pr_number": 86,
  "pr_url": "https://github.com/galacoder/medilink-convex/pull/86",
  "pr_created_at": "2026-02-18T02:15:41Z"
}
